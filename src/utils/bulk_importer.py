"""
ЁЯУБ Bulk Product Importer
р╕гр╕░р╕Ър╕Ър╕Щр╕│р╣Ар╕Вр╣Йр╕▓р╕кр╕┤р╕Щр╕Др╣Йр╕▓р╕Ир╕│р╕Щр╕зр╕Щр╕бр╕▓р╕Бр╕Ир╕▓р╕Б CSV/Excel
"""

import pandas as pd
import os
import re
from typing import Dict, List, Optional, Tuple
from datetime import datetime
import logging

from .supabase_database import SupabaseDatabase

class BulkProductImporter:
    """р╕Др╕ер╕▓р╕кр╕кр╕│р╕лр╕гр╕▒р╕Ър╕Щр╕│р╣Ар╕Вр╣Йр╕▓р╕кр╕┤р╕Щр╕Др╣Йр╕▓р╕Ир╕│р╕Щр╕зр╕Щр╕бр╕▓р╕Б"""
    
    def __init__(self):
        self.db = SupabaseDatabase()
        self.logger = logging.getLogger(__name__)
        
        # р╕Др╕нр╕ер╕▒р╕бр╕Щр╣Мр╕Чр╕╡р╣Ир╕Ир╕│р╣Ар╕Ыр╣Зр╕Щр╕кр╕│р╕лр╕гр╕▒р╕Ър╕Бр╕▓р╕гр╕Щр╕│р╣Ар╕Вр╣Йр╕▓
        self.required_columns = [
            'product_name',
            'category', 
            'price',
            'affiliate_link'
        ]
        
        # р╕Др╕нр╕ер╕▒р╕бр╕Щр╣Мр╕Чр╕▒р╣Йр╕Зр╕лр╕бр╕Фр╕Чр╕╡р╣Ир╕гр╕нр╕Зр╕гр╕▒р╕Ъ
        self.supported_columns = [
            'product_code',
            'product_name',
            'description', 
            'category',
            'subcategory',
            'price',
            'original_price',
            'discount_percentage',
            'affiliate_link',
            'image_url',
            'brand',
            'rating',
            'review_count',
            'sold_count',
            'stock_quantity',
            'tags',
            'commission_rate',
            'is_featured',
            'is_active'
        ]
    
    def validate_file(self, file_path: str) -> Tuple[bool, str]:
        """р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╣Др╕Яр╕ер╣Мр╕Бр╣Ир╕нр╕Щр╕Щр╕│р╣Ар╕Вр╣Йр╕▓"""
        if not os.path.exists(file_path):
            return False, "р╣Др╕Яр╕ер╣Мр╣Др╕бр╣Ир╕Юр╕Ъ"
        
        file_extension = os.path.splitext(file_path)[1].lower()
        if file_extension not in ['.csv', '.xlsx', '.xls']:
            return False, "р╕гр╕нр╕Зр╕гр╕▒р╕Ър╣Ар╕Йр╕Юр╕▓р╕░р╣Др╕Яр╕ер╣М CSV р╣Бр╕ер╕░ Excel р╣Ар╕Чр╣Ир╕▓р╕Щр╕▒р╣Йр╕Щ"
        
        try:
            # р╕нр╣Ир╕▓р╕Щр╣Др╕Яр╕ер╣Мр╕Чр╕Фр╕кр╕нр╕Ъ
            if file_extension == '.csv':
                df = pd.read_csv(file_path, nrows=1)
            else:
                df = pd.read_excel(file_path, nrows=1)
            
            # р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕Др╕нр╕ер╕▒р╕бр╕Щр╣Мр╕Чр╕╡р╣Ир╕Ир╕│р╣Ар╕Ыр╣Зр╕Щ
            missing_columns = []
            for col in self.required_columns:
                if col not in df.columns:
                    missing_columns.append(col)
            
            if missing_columns:
                return False, f"р╕Вр╕▓р╕Фр╕Др╕нр╕ер╕▒р╕бр╕Щр╣Мр╕Чр╕╡р╣Ир╕Ир╕│р╣Ар╕Ыр╣Зр╕Щ: {', '.join(missing_columns)}"
            
            return True, "р╣Др╕Яр╕ер╣Мр╕Цр╕╣р╕Бр╕Хр╣Йр╕нр╕З"
            
        except Exception as e:
            return False, f"р╣Др╕бр╣Ир╕кр╕▓р╕бр╕▓р╕гр╕Цр╕нр╣Ир╕▓р╕Щр╣Др╕Яр╕ер╣Мр╣Др╕Фр╣Й: {str(e)}"
    
    def clean_data(self, df: pd.DataFrame) -> pd.DataFrame:
        """р╕Чр╕│р╕Др╕зр╕▓р╕бр╕кр╕░р╕нр╕▓р╕Фр╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Бр╣Ир╕нр╕Щр╕Щр╕│р╣Ар╕Вр╣Йр╕▓"""
        # р╕кр╕гр╣Йр╕▓р╕З DataFrame р╣Гр╕лр╕бр╣И
        cleaned_df = df.copy()
        
        # р╕Чр╕│р╕Др╕зр╕▓р╕бр╕кр╕░р╕нр╕▓р╕Фр╕Др╕нр╕ер╕▒р╕бр╕Щр╣М
        for col in cleaned_df.columns:
            if col in self.supported_columns:
                if col == 'product_name':
                    # р╕Хр╕▒р╕Фр╕Кр╣Ир╕нр╕Зр╕зр╣Ир╕▓р╕Зр╣Бр╕ер╕░р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕Др╕зр╕▓р╕бр╕вр╕▓р╕з
                    cleaned_df[col] = cleaned_df[col].astype(str).str.strip()
                    cleaned_df = cleaned_df[cleaned_df[col].str.len() > 0]
                
                elif col == 'price':
                    # р╣Бр╕Ыр╕ер╕Зр╕гр╕▓р╕Др╕▓р╣Ар╕Ыр╣Зр╕Щр╕Хр╕▒р╕зр╣Ар╕ер╕В
                    cleaned_df[col] = pd.to_numeric(cleaned_df[col], errors='coerce')
                    cleaned_df = cleaned_df[cleaned_df[col] > 0]
                
                elif col == 'category':
                    # р╕Чр╕│р╕Др╕зр╕▓р╕бр╕кр╕░р╕нр╕▓р╕Фр╕лр╕бр╕зр╕Фр╕лр╕бр╕╣р╣И
                    cleaned_df[col] = cleaned_df[col].astype(str).str.strip()
                    cleaned_df = cleaned_df[cleaned_df[col].str.len() > 0]
                
                elif col == 'affiliate_link':
                    # р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕ер╕┤р╕Зр╕Бр╣М
                    cleaned_df[col] = cleaned_df[col].astype(str).str.strip()
                    url_pattern = re.compile(r'^https?://')
                    cleaned_df = cleaned_df[cleaned_df[col].str.match(url_pattern, na=False)]
                
                elif col in ['rating', 'discount_percentage', 'commission_rate']:
                    # р╣Бр╕Ыр╕ер╕Зр╣Ар╕Ыр╣Зр╕Щр╕Хр╕▒р╕зр╣Ар╕ер╕В
                    cleaned_df[col] = pd.to_numeric(cleaned_df[col], errors='coerce')
                
                elif col in ['review_count', 'sold_count', 'stock_quantity']:
                    # р╣Бр╕Ыр╕ер╕Зр╣Ар╕Ыр╣Зр╕Щр╕Ир╕│р╕Щр╕зр╕Щр╣Ар╕Хр╣Зр╕б
                    cleaned_df[col] = pd.to_numeric(cleaned_df[col], errors='coerce').fillna(0).astype(int)
                
                elif col in ['is_featured', 'is_active']:
                    # р╣Бр╕Ыр╕ер╕Зр╣Ар╕Ыр╣Зр╕Щ boolean
                    cleaned_df[col] = cleaned_df[col].fillna(True).astype(bool)
        
        # р╕ер╕Ър╣Бр╕Цр╕зр╕Чр╕╡р╣Ир╕бр╕╡р╕Вр╣Йр╕нр╕бр╕╣р╕ер╕кр╕│р╕Др╕▒р╕Нр╕Вр╕▓р╕Фр╕лр╕▓р╕в
        cleaned_df = cleaned_df.dropna(subset=self.required_columns)
        
        return cleaned_df
    
    def generate_product_codes(self, df: pd.DataFrame) -> pd.DataFrame:
        """р╕кр╕гр╣Йр╕▓р╕Зр╕гр╕лр╕▒р╕кр╕кр╕┤р╕Щр╕Др╣Йр╕▓р╕нр╕▒р╕Хр╣Вр╕Щр╕бр╕▒р╕Хр╕┤"""
        result_df = df.copy()
        
        # р╕лр╕▓р╕Бр╣Др╕бр╣Ир╕бр╕╡р╕Др╕нр╕ер╕▒р╕бр╕Щр╣М product_code р╕лр╕гр╕╖р╕нр╕бр╕╡р╕Др╣Ир╕▓р╕зр╣Ир╕▓р╕З
        if 'product_code' not in result_df.columns:
            result_df['product_code'] = ''
        
        # р╕кр╕гр╣Йр╕▓р╕Зр╕гр╕лр╕▒р╕кр╣Гр╕лр╕бр╣Ир╕кр╕│р╕лр╕гр╕▒р╕Ър╕гр╕▓р╕вр╕Бр╕▓р╕гр╕Чр╕╡р╣Ир╣Др╕бр╣Ир╕бр╕╡р╕гр╕лр╕▒р╕к
        empty_codes = result_df['product_code'].isna() | (result_df['product_code'] == '')
        
        for idx in result_df[empty_codes].index:
            # р╕кр╕гр╣Йр╕▓р╕Зр╕гр╕лр╕▒р╕кр╕Ир╕▓р╕Бр╕лр╕бр╕зр╕Фр╕лр╕бр╕╣р╣Ир╣Бр╕ер╕░р╕ер╕│р╕Фр╕▒р╕Ъ
            category = result_df.loc[idx, 'category']
            category_prefix = ''.join([c.upper() for c in category if c.isalpha()])[:3]
            if len(category_prefix) < 3:
                category_prefix = f"{category_prefix}{'X' * (3 - len(category_prefix))}"
            
            # р╕лр╕▓р╕ер╕│р╕Фр╕▒р╕Ър╕Цр╕▒р╕Фр╣Др╕Ы
            existing_codes = self.db.get_product_codes_by_prefix(category_prefix)
            next_number = len(existing_codes) + 1
            
            result_df.loc[idx, 'product_code'] = f"{category_prefix}{next_number:04d}"
        
        return result_df
    
    def import_from_file(self, file_path: str, batch_size: int = 100) -> Dict:
        """р╕Щр╕│р╣Ар╕Вр╣Йр╕▓р╕кр╕┤р╕Щр╕Др╣Йр╕▓р╕Ир╕▓р╕Бр╣Др╕Яр╕ер╣М"""
        result = {
            'success': False,
            'total_rows': 0,
            'processed_rows': 0,
            'successful_imports': 0,
            'failed_imports': 0,
            'errors': [],
            'duplicates': 0,
            'summary': {}
        }
        
        try:
            # р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╣Др╕Яр╕ер╣М
            is_valid, message = self.validate_file(file_path)
            if not is_valid:
                result['errors'].append(message)
                return result
            
            # р╕нр╣Ир╕▓р╕Щр╣Др╕Яр╕ер╣М
            file_extension = os.path.splitext(file_path)[1].lower()
            if file_extension == '.csv':
                df = pd.read_csv(file_path)
            else:
                df = pd.read_excel(file_path)
            
            result['total_rows'] = len(df)
            self.logger.info(f"Starting import of {result['total_rows']} products")
            
            # р╕Чр╕│р╕Др╕зр╕▓р╕бр╕кр╕░р╕нр╕▓р╕Фр╕Вр╣Йр╕нр╕бр╕╣р╕е
            cleaned_df = self.clean_data(df)
            result['processed_rows'] = len(cleaned_df)
            
            if len(cleaned_df) == 0:
                result['errors'].append("р╣Др╕бр╣Ир╕бр╕╡р╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Чр╕╡р╣Ир╕Цр╕╣р╕Бр╕Хр╣Йр╕нр╕Зр╕кр╕│р╕лр╕гр╕▒р╕Ър╕Щр╕│р╣Ар╕Вр╣Йр╕▓")
                return result
            
            # р╕кр╕гр╣Йр╕▓р╕Зр╕гр╕лр╕▒р╕кр╕кр╕┤р╕Щр╕Др╣Йр╕▓
            final_df = self.generate_product_codes(cleaned_df)
            
            # р╕Щр╕│р╣Ар╕Вр╣Йр╕▓р╣Бр╕Ър╕Ър╣Бр╕Ър╕Хр╕Кр╣М
            successful_imports = 0
            failed_imports = 0
            duplicates = 0
            
            for i in range(0, len(final_df), batch_size):
                batch_df = final_df.iloc[i:i+batch_size]
                
                for _, row in batch_df.iterrows():
                    try:
                        product_data = self._prepare_product_data(row)
                        
                        # р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕кр╕┤р╕Щр╕Др╣Йр╕▓р╕Лр╣Йр╕│
                        if self.db.get_product_by_code(product_data['product_code']):
                            duplicates += 1
                            continue
                        
                        # р╣Ар╕Юр╕┤р╣Ир╕бр╕кр╕┤р╕Щр╕Др╣Йр╕▓
                        if self.db.add_product(product_data):
                            successful_imports += 1
                        else:
                            failed_imports += 1
                            
                    except Exception as e:
                        failed_imports += 1
                        result['errors'].append(f"Row {i+1}: {str(e)}")
            
            result['successful_imports'] = successful_imports
            result['failed_imports'] = failed_imports
            result['duplicates'] = duplicates
            result['success'] = successful_imports > 0
            
            # р╕кр╕гр╕╕р╕Ыр╕Ьр╕ер╕ер╕▒р╕Юр╕Шр╣М
            result['summary'] = {
                'categories': final_df['category'].nunique(),
                'brands': final_df.get('brand', pd.Series()).nunique() if 'brand' in final_df.columns else 0,
                'average_price': float(final_df['price'].mean()),
                'price_range': {
                    'min': float(final_df['price'].min()),
                    'max': float(final_df['price'].max())
                }
            }
            
            self.logger.info(f"Import completed: {successful_imports} success, {failed_imports} failed, {duplicates} duplicates")
            
        except Exception as e:
            result['errors'].append(f"Import error: {str(e)}")
            self.logger.error(f"Import failed: {str(e)}")
        
        return result
    
    def _prepare_product_data(self, row: pd.Series) -> Dict:
        """р╣Ар╕Хр╕гр╕╡р╕вр╕бр╕Вр╣Йр╕нр╕бр╕╣р╕ер╕кр╕┤р╕Щр╕Др╣Йр╕▓р╕кр╕│р╕лр╕гр╕▒р╕Ър╕Ър╕▒р╕Щр╕Чр╕╢р╕Б"""
        product_data = {}
        
        # р╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Юр╕╖р╣Йр╕Щр╕Рр╕▓р╕Щ
        for col in self.supported_columns:
            if col in row.index and pd.notna(row[col]):
                if col in ['is_featured', 'is_active']:
                    product_data[col] = bool(row[col])
                elif col in ['price', 'original_price', 'rating', 'discount_percentage', 'commission_rate']:
                    product_data[col] = float(row[col])
                elif col in ['review_count', 'sold_count', 'stock_quantity']:
                    product_data[col] = int(row[col])
                else:
                    product_data[col] = str(row[col]).strip()
        
        # р╕Др╣Ир╕▓р╣Ар╕гр╕┤р╣Ир╕бр╕Хр╣Йр╕Щ
        if 'is_active' not in product_data:
            product_data['is_active'] = True
        if 'is_featured' not in product_data:
            product_data['is_featured'] = False
        if 'commission_rate' not in product_data:
            product_data['commission_rate'] = 5.0
        
        # р╣Ар╕Юр╕┤р╣Ир╕бр╕зр╕▒р╕Щр╕Чр╕╡р╣И
        product_data['created_at'] = datetime.now().isoformat()
        product_data['updated_at'] = datetime.now().isoformat()
        
        return product_data
    
    def create_sample_csv(self, file_path: str):
        """р╕кр╕гр╣Йр╕▓р╕Зр╣Др╕Яр╕ер╣Мр╕Хр╕▒р╕зр╕нр╕вр╣Ир╕▓р╕Зр╕кр╕│р╕лр╕гр╕▒р╕Ър╕Бр╕▓р╕гр╕Щр╕│р╣Ар╕Вр╣Йр╕▓"""
        sample_data = [
            {
                'product_code': 'ELE0001',
                'product_name': 'iPhone 15 Pro Max 256GB',
                'description': 'р╕кр╕бр╕▓р╕гр╣Мр╕Чр╣Вр╕Яр╕Щр╕гр╕╕р╣Ир╕Щр╕ер╣Ир╕▓р╕кр╕╕р╕Фр╕Ир╕▓р╕Б Apple р╕Юр╕гр╣Йр╕нр╕бр╕Бр╕ер╣Йр╕нр╕Зр╕гр╕░р╕Фр╕▒р╕Ър╕бр╕╖р╕нр╕нр╕▓р╕Кр╕╡р╕Ю',
                'category': 'р╕нр╕┤р╣Ар╕ер╣Зр╕Бр╕Чр╕гр╕нр╕Щр╕┤р╕Бр╕кр╣М',
                'subcategory': 'р╕бр╕╖р╕нр╕Цр╕╖р╕н',
                'price': 45900.00,
                'original_price': 47900.00,
                'discount_percentage': 4.18,
                'affiliate_link': 'https://example.com/iphone15promax',
                'image_url': 'https://example.com/images/iphone15.jpg',
                'brand': 'Apple',
                'rating': 4.8,
                'review_count': 1250,
                'sold_count': 850,
                'stock_quantity': 100,
                'tags': 'р╕кр╕бр╕▓р╕гр╣Мр╕Чр╣Вр╕Яр╕Щ,Apple,iPhone,5G',
                'commission_rate': 3.5,
                'is_featured': True,
                'is_active': True
            },
            {
                'product_code': 'FAB0001', 
                'product_name': 'р╣Ар╕кр╕╖р╣Йр╕нр╣Ар╕Кр╕┤р╣Йр╕Хр╕Ьр╣Йр╕▓р╕Др╕нр╕Хр╕Хр╕нр╕Щ',
                'description': 'р╣Ар╕кр╕╖р╣Йр╕нр╣Ар╕Кр╕┤р╣Йр╕Хр╣Бр╕Яр╕Кр╕▒р╣Ир╕Щр╕Ьр╕╣р╣Йр╕Кр╕▓р╕вр╣Бр╕Ър╕Ър╣Ар╕гр╕╡р╕вр╕Ър╕лр╕гр╕╣',
                'category': 'р╣Бр╕Яр╕Кр╕▒р╣Ир╕Щ',
                'subcategory': 'р╣Ар╕кр╕╖р╣Йр╕нр╕Ьр╣Йр╕▓р╕Ьр╕╣р╣Йр╕Кр╕▓р╕в',
                'price': 890.00,
                'original_price': 1290.00,
                'discount_percentage': 31.01,
                'affiliate_link': 'https://example.com/cotton-shirt',
                'image_url': 'https://example.com/images/shirt.jpg',
                'brand': 'BasicWear',
                'rating': 4.2,
                'review_count': 68,
                'sold_count': 245,
                'stock_quantity': 50,
                'tags': 'р╣Ар╕кр╕╖р╣Йр╕нр╣Ар╕Кр╕┤р╣Йр╕Х,р╣Бр╕Яр╕Кр╕▒р╣Ир╕Щ,р╕Ьр╕╣р╣Йр╕Кр╕▓р╕в,р╕Др╕нр╕Хр╕Хр╕нр╕Щ',
                'commission_rate': 8.0,
                'is_featured': False,
                'is_active': True
            }
        ]
        
        df = pd.DataFrame(sample_data)
        df.to_csv(file_path, index=False, encoding='utf-8-sig')
        
        return f"р╕кр╕гр╣Йр╕▓р╕Зр╣Др╕Яр╕ер╣Мр╕Хр╕▒р╕зр╕нр╕вр╣Ир╕▓р╕З: {file_path}"

# р╕кр╕гр╣Йр╕▓р╕З instance р╕кр╕│р╕лр╕гр╕▒р╕Ър╣Гр╕Кр╣Йр╕Зр╕▓р╕Щ
bulk_importer = BulkProductImporter()